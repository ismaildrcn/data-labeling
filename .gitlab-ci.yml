default:
  before_script:
    - $env:Path = "C:\Python\" + ";" + "C:\Python\Scripts\" + ";" + $env:Path
    - python --version

stages:
  - build
  - release
  - publish

build:
  stage: build
  tags:
    - windows
  script:
    - python -m pip install --upgrade pip
    - echo Uygulama test ediliyor...
    # - python main.py

release:
  stage: release
  tags:
    - windows
  script:
    - python -m pip install -r requirements.txt
    - python -m pip install pyinstaller
    - python -m PyInstaller main.spec
    - |
      $env:CI_JOB_ID | Out-File -FilePath "job_id.txt"
      $previousTag = git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>$null
      if (-not $previousTag) { $previousTag = "no previous tag" }
      $previousTag | Out-File -FilePath "previous_tag.txt"
      $commitList = git log --oneline "$previousTag..$env:CI_COMMIT_TAG" --format="%h %s"
      $commitList | Out-File -FilePath "commit_list.txt"
  artifacts:
    paths:
      - dist/
      - job_id.txt
      - previous_tag.txt
      - commit_list.txt

publish:
  stage: publish
  tags:
    - windows
  rules:
    - if: $CI_COMMIT_TAG
  needs:
    - job: release
      artifacts: true

  before_script:
    - |
      $runnerDir = "C:\GitLab-Runner"
      $env:Path = "$runnerDir;" + $env:Path
      Write-Host ">> PATH includes: $runnerDir"

  script:
    - |
      $jobId       = Get-Content job_id.txt
      $previousTag = Get-Content previous_tag.txt
      $commitList  = Get-Content commit_list.txt

      $description = "Changes since $($previousTag):`n$commitList"

      & "C:\GitLab-Runner\release-cli.exe" create `
        --name "Release $env:CI_COMMIT_TAG" `
        --tag-name "$env:CI_COMMIT_TAG" `
        --description "$description" `
        --assets-link "name=Application_Executable,url=$CI_PROJECT_URL/-/jobs/$jobId/artifacts/download,link_type=package"
